extends ../layout
block link
  style.
    table tr th {
      text-align: center
    }
    table tr td {
      text-align: center;
    }
block content
  section.content.dashboard(style='padding: 15px;')
    .panel.panel-default.add-qr-panel(style='display: none;')
      .panel-heading #{__("Add QR")}
      .panel-body
        form.add-form(action='/dashboard/manage/add_warehouse' method='post')
          .form-group.clearfix.col-md-2
            label.display-block #{__("idx")}
            input.form-control.new-idx(type='text', placeholder='idx', required='')
          .form-group.clearfix.col-md-2
            label.display-block #{__("Factoryidx")}
            input.form-control.new-factoryidx(type='text', placeholder='Factoryidx')
          .form-group.clearfix.col-md-2
            label.display-block #{__("WorkOrderidx")}
            input.form-control.new-workorderidx(type='text', placeholder='WorkOrderidx')
          .form-group.clearfix.col-md-2
            label.display-block #{__("OutPlace")}
            input.form-control.new-outplace(type='text', placeholder='OutPlace')
          .form-group.clearfix.col-md-2
            label.display-block #{__("Delivered")}
            input.form-control.new-delivered(type='text', placeholder='Delivered')
          .form-group.clearfix.col-md-2
            label.display-block #{__("ReceivePlace")}
            input.form-control.new-receiveplace(type='text', placeholder='ReceivePlace')          
          .form-group.clearfix.col-md-2
            label.display-block #{__("OutDate")}
            input.form-control.date.new-outdate(type='text', placeholder='Please choose a date...', data-format='YYYY-MM-DD')
          .form-group.clearfix.col-md-2
            label.display-block #{__("RcvdDate")}
            input.form-control.date.new-rcvddate(type='text', placeholder='Please choose a date...', data-format='YYYY-MM-DD')
          .form-group.clearfix.col-md-2
            label.display-block #{__("Remarks")}
            input.form-control.new-remarks(type='text', placeholder='Remarks')
          .form-group.clearfix.col-md-2
            label.display-block #{__("OutType")}
            select.select-bar.new-outtype(style='width: 100%;', name='handler')
              option(value='T') #{__("Fabric")}
              option(value='F') #{__("Garment")}
              option(value='O') #{__("Others")}
          .form-group.clearfix.col-md-2
            label.display-block #{__("Location")}
            input.form-control.new-location(type='text', placeholder='Location')
          .form-group.clearfix.col-md-2
            label.display-block #{__("RefNo")}
            input.form-control.new-refno(type='text', placeholder='RefNo')          
          .form-group.col-md-12
            button.btn.btn-sm.btn-success.pull-right(type='submit', style='margin-top: 25px;') #{__("Add QR")}
    .panel.panel-default.update-qr-panel(style='display: none;')
      .panel-heading #{__("Update QR")}
      .panel-body
        form.update-form(action='/dashboard/manage/update_warehouse' method='post')
          //- .form-group.clearfix.col-md-2
          //-   label.display-block #{__("idx")}
          input.form-control.update-idx(type='hidden', placeholder='idx', required='')
          .form-group.clearfix.col-md-2
            label.display-block #{__("Factoryidx")}
            select.select-bar.update-factoryidx(style='width: 100%;')
              - for (var i = 0; i < l_factory.length; ++i) {
                  option(value='#{l_factory[i].Idx}') #{l_factory[i].Name}
              - }
            //- input.form-control.update-factoryidx(type='text', placeholder='Factoryidx')
          .form-group.clearfix.col-md-2
            label.display-block #{__("WorkOrderidx")}
            input.form-control.update-workorderidx(type='text', placeholder='WorkOrderidx')
          .form-group.clearfix.col-md-2
            label.display-block #{__("OutPlace")}
            select.select-bar.update-outplace(style='width: 100%;')
              - for (var i = 0; i < l_outplace.length; ++i) {
                  option(value='#{l_outplace[i].Idx}') #{l_outplace[i].Name}
              - }
            //- input.form-control.update-outplace(type='text', placeholder='OutPlace')
          .form-group.clearfix.col-md-2
            label.display-block #{__("Delivered")}
            input.form-control.update-delivered(type='text', placeholder='Delivered')
          .form-group.clearfix.col-md-2
            label.display-block #{__("ReceivePlace")}
            select.select-bar.update-receiveplace(style='width: 100%;')
              - for (var i = 0; i < l_receiveplace.length; ++i) {
                  option(value='#{l_receiveplace[i].Idx}') #{l_receiveplace[i].Name}
              - }
            //- input.form-control.update-receiveplace(type='text', placeholder='ReceivePlace')
          .form-group.clearfix.col-md-2
            label.display-block #{__("OutDate")}
            input.form-control.date.update-outdate(type='text', placeholder='Please choose a date...', data-format='YYYY-MM-DD')
          .form-group.clearfix.col-md-2
            label.display-block #{__("RcvdDate")}
            input.form-control.date.update-rcvddate(type='text', placeholder='Please choose a date...', data-format='YYYY-MM-DD')
          .form-group.clearfix.col-md-2
            label.display-block #{__("Remarks")}
            input.form-control.update-remarks(type='text', placeholder='Remarks')
          .form-group.clearfix.col-md-2
            label.display-block #{__("OutType")}
            select.select-bar.update-outtype(style='width: 100%;', name='handler')
              option(value='T') #{__("Fabric")}
              option(value='F') #{__("Garment")}
              option(value='O') #{__("Others")}
          .form-group.clearfix.col-md-2
            label.display-block #{__("Location")}
            input.form-control.update-location(type='text', placeholder='Location')
          .form-group.clearfix.col-md-2
            label.display-block #{__("RefNo")}
            input.form-control.update-refno(type='text', placeholder='RefNo')          
          .form-group.col-md-12            
            button.btn.btn-sm.btn-success.pull-right(type='submit', style='margin-left: 25px;') #{__("Update Data")}
            .btn.btn-sm.btn-success.pull-right.remove-data #{__("Delete Data")}
    .panel.panel-default      
      .panel-heading  #{__("WAREHOUSE")}
        //- a.btn.btn-sm.btn-success.new-button
        //-   i.fa.fa-plus.m-r-5
        //-   | #{__("Add New QR")}
      .panel-body
        div(style="overflow:auto")
          table.table.table-striped.table-hover.js-exportable.dataTable.qr-table
            thead
              tr
                th #{__("idx")}
                th #{__("Factoryidx")}
                th #{__("WorkOrderidx#")}
                th #{__("OutPlace")}
                th #{__("Delivered")}
                th #{__("ReceivePlace")}
                th #{__("OutDate")}
                th #{__("RcvdDate")}
                th #{__("Remarks")}
                th #{__("OutType")}
                th #{__("Location")}
                th #{__("RefNo")}
                th #{__("Detail")}
            tbody            
block script
  script(src='/assets/plugins/moment/moment.js')
  script(src='/assets/plugins/eonasdan-bootstrap-datetimepicker/src/js/bootstrap-datetimepicker.js')
  script.
    var list;
    var l_factory = (!{JSON.stringify(l_factory)});
    var getFactoryName = function(id) {
      for(var i = 0; i < l_factory.length; i++) {
        if(l_factory[i].Idx == id) return l_factory[i].Name;
      }
      return '';
    }
    var l_outplace = (!{JSON.stringify(l_outplace)});
    var getOutPlaceName = function(id) {
      for(var i = 0; i < l_outplace.length; i++) {
        if(l_outplace[i].Idx == id) return l_outplace[i].Name;
      }
      return '';
    }
    var l_receiveplace = (!{JSON.stringify(l_receiveplace)});
    var getReceivePlaceName = function(id) {
      for(var i = 0; i < l_receiveplace.length; i++) {
        if(l_receiveplace[i].Idx == id) return l_receiveplace[i].Name;
      }
      return '';
    }
    var loadQR = function() {
      $.ajax({
        url: '/dashboard/input/manage/load_warehouse',
        type:'POST',
        data: {          
        },
        success: function(res) {
          $('.lds-spinner').fadeOut();
          $('.update-qr-panel').fadeOut();
          if(res.status) {
            var tableData = [];
            list = res.list;
            for(var i = 0; i < res.list.length; i++) {
              tableData.push([
                res.list[i].Idx, getFactoryName(res.list[i].FactoryIdx), res.list[i].WorkOrderIdx, getOutPlaceName(res.list[i].OutPlace), res.list[i].Delivered,
                getReceivePlaceName(res.list[i].ReceivePlace), res.list[i].OutDate.split('T')[0], res.list[i].RcvdDate.split('T')[0], res.list[i].Remarks,
                res.list[i].OutType, res.list[i].Location, res.list[i].RefNo,
                `<a href="/dashboard/input/manage/detail?id=`+res.list[i].Idx+`&type=`+res.list[i].OutType+`">Detail</a>`
              ])
            }
            $('.qr-table').dataTable().fnClearTable();
            if(tableData.length > 0){
              $('.qr-table').dataTable().fnAddData(tableData);
              $('.qr-table').dataTable().fnDraw();
            }
            refreshEvent();
          } else {
            alert('Cannot load QR list. Please contact support team.')
          }
        }
      })
    };
    var init = function() {
      $('.select-bar').select2();
      $(".date").datetimepicker({
        format: 'YYYY-MM-DD',
        showClear: true
      });
      $('.qr-table').DataTable({
        "pageLength": 25,
        responsive: true,
        dom: '<"html5buttons"B>lTfgtip',
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
      });

      $('.add-qr-panel').on('click', 'a.panel-close', function () {
        $(this).parents('.add-qr-panel').fadeOut();
      });
      $('.update-qr-panel').on('click', 'a.panel-close', function () {
        $(this).parents('.update-qr-panel').fadeOut();
      });
      $('.new-button').on('click', function(){
        $('.add-qr-panel').fadeIn();
        $('.update-qr-panel').fadeOut();
      })

      $('.lds-spinner').fadeIn();
      loadQR();

      $('.qr-table').on( 'page.dt', function () {
        setTimeout(function(){
          refreshEvent();
        }, 500)
      });

      $('.qr-table').on( 'search.dt', function () {
        setTimeout(function(){
          refreshEvent();
        }, 500)
    });
    }
    init();

    var refreshEvent = function() {
      $('.qr-table').off();
      $('.qr-table tbody tr').on('dblclick', function() {
        $('.add-qr-panel').fadeOut();
        $('.update-qr-panel').fadeIn();
        for(var i = 0; i < list.length; i++) {
          if(list[i].Idx == $($(this).find('td')[0]).html()) {
            $('.update-idx').val(list[i].Idx);
            $('.update-factoryidx').val(list[i].FactoryIdx).trigger('change');
            $('.update-workorderidx').val(list[i].WorkOrderIdx);
            $('.update-outplace').val(list[i].OutPlace).trigger('change');
            $('.update-delivered').val(list[i].Delivered);
            $('.update-receiveplace').val(list[i].ReceivePlace).trigger('change');
            $('.update-outdate').val(list[i].OutDate.split('T')[0]);
            $('.update-rcvddate').val(list[i].RcvdDate.split('T')[0]);
            $('.update-remarks').val(list[i].Remarks);
            $('.update-outtype').val(list[i].OutType).trigger('change');
            $('.update-location').val(list[i].Location);
            $('.update-refno').val(list[i].RefNo)
            break;
          }
        }
      })
    }

    $('.update-form').submit(function(e) {
      $('.lds-spinner').fadeIn();
      e.preventDefault();
      $.ajax({
        url: '/dashboard/input/manage/update_warehouse',
        type: 'POST',
        data: {
          Idx: $('.update-idx').val(),
          FactoryIdx: $('.update-factoryidx').val(),
          WorkOrderIdx: $('.update-workorderidx').val(),
          OutPlace: $('.update-outplace').val(),
          Delivered: $('.update-delivered').val(),
          ReceivePlace: $('.update-receiveplace').val(),
          OutDate: $('.update-outdate').val(),
          RcvdDate: $('.update-rcvddate').val(),
          Remarks: $('.update-remarks').val(),
          OutType: $('.update-outtype').val(),
          Location: $('.update-location').val(),
          RefNo: $('.update-refno').val()
        },
        success: function(res) {
          $('.lds-spinner').fadeOut();
          if(res.status == 1) {
            $(this).parents('.update-qr-panel').fadeOut();
            loadQR();
          } else {
            alert('Cannot change data. Please contact support team.')
          }          
        }
      })
    })

    $('.remove-data').on('click', function() {
      $('.lds-spinner').fadeIn();
      var tmp;
      for(var i = 0; i < list.length; i++) {
        if($('.update-idx').val() == list[i].Idx) {
          tmp = list[i];
        }
      }
      $.ajax({
        url: '/dashboard/input/manage/input/delete_warehouse',
        type: 'POST',
        data: {
          idx: tmp.Idx,
          type: tmp.OutType,
          refno: tmp.RefNo
        },
        success: function(res) {
          $('.lds-spinner').fadeOut();
          if(res.status != 0) {
            $(this).parents('.update-qr-panel').fadeOut();
            loadQR();
          } else {
            alert('Cannot Delete. Please contact support team.')
          }
        }
      })
    })